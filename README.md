# Модель временных рядов для прогнозирования MSKU в ритейле

В данном руководстве представлена модель на языке Python для предсказания поведения нескольких временных рядов из msku, относящихся 
к одному хиду.

В модели строится предсказание временного ряда для каждого отдельного msku по дням, используя линейную регрессию,
которая принимает на вход различные фичи, построенные на окне исторических данных и на информации о дне
предсказания. Далее (опционально) модель переучивается для каждого отдельного временного ряда, используя в качестве
входной фичи также предсказание лучшей по метрикам модели на предыдущем шаге.

## Установка

Для работы модели необходимы файлы `features.py`, `model.py` и `preprocessing.py`. Также для лучших предсказаний
понадобится файл с историческими данными динамики курса доллара (либо другой экономической величины, отражающей
состояние экономики в стране), путь до которого нужно будет передать при инициализации модели (подробнее см. Загрузка
данных по курсу валюты).

## Пример

Начнём с краткого автономного примера работы.

```python
import model as m
from sklearn.metrics import mean_absolute_percentage_error

# Выгружаем номера msku относящиеся к одному хиду
hid = 2625
msku = m.get_msku_by_hid(2625, 'data/seasonality_hid_model_msku')

# Выгружаем данные для этих msku
data = m.collect_msku_data(msku, 'data/seasonality_data_by_msku')

# Инициализируем и обучаем модель
model = m.MSKUTimeSeriesModel('usd.csv')
train, test = model.train_test_split(data)
model.fit(train)

# Получаем предсказание и проверяем метрики
pred = model.predict(train)
some_msku = list(msku)[0]
y_pred = pred[some_msku]
y_test = test[test.msku == some_msku].y
error = mean_absolute_percentage_error(y_test, y_pred)

# Сохраняем модель
model.save_models('model')

# Загружаем модель из сохранённого на диске
some_model = m.MSKUTimeSeriesModel('usd.csv')
some_model.download_models('model')
```

## Выгрузка данных в нужном виде

Для начала находим набор msku относящихся к одному хиду. Для этого понадобится файл, построчно хранящий информацию о 
парах хид-msku, где хид может встречаться несколько раз с различными msku.
```python
msku = m.get_msku_by_hid(hid_number, path_to_hid_msku, sep='\t')
```

Теперь используя файл, содержащий построчно информацию о msku, дате (в любом формате, который принимает 
`pandas.to_datetime()`) и таргете, получаем датасет для обучения.
```python
data = m.collect_msku_data(msku, path_to_msku_data, header=True, gmv_ind=0, msku_ind=1,date_ind=2)
```
В качестве аргументов можно передать, содержит ли файл строку заголовок, и указать позиции номера msku, даты и таргета
в строке (см. документацию соответствующей функции).

## Обучение

**Инициализация:**
```python
model = m.MSKUTimeSeriesModel('usd.csv', forecast_period=8, window_width=30, num_folds=10, with_refit=True)
```
При инициализации можно указать:

* `usd_path`: путь до файла с динамикой валюты, в таком случае модель в качестве фичи будет использовать курс валюты.
* `forecast_period`: длину периода, на который модель будет делать предсказание.
* `window_width`: ширину окна, на котором будут строиться оконные фичи.
* `num_foldsv`: количество фолдов в кросс-валидации при обучении модели.
* `with_refit`: нужно ли переобучать модель, используя предсказания лучшей по метрикам модели на каком-то временном ряду
в качестве фичи на других временных рядах.

**Train - Test:**
```python
train, test = model.train_test_split(data)
```
Принимает данные в формате, в котором их возвращает функция `collect_msku_data()`

**Обучение:**
```python
model.fit(train)
```

## Получение предсказаний

```python
pred = model.predict(train)
```
Для обучения в модель нужно передать данные по всем msku, на которые планируется делать предсказание (все эти msku 
должны быть задействованы в обучении, иначе функция выдаст ошибку). Переданные данные будут использованы для 
построения оконных фичей. 

Началом периода предсказаний будет считаться день, следующий за последним в переданных данных 
днём. 

Если при инициализации модели был задан параметр `with_refit=True`, то в данных для предсказания обязательно
должен содержаться msku, модель для которого оказалась лучшей (его можно посмотреть через параметр `model.best_msku`),
иначе функция вернёт ошибку.

Функция возвращает словарь, где по ключу, равному номеру msku можно получить соответсвующее предсказание.

##  Сохранение модели

```python
model.save_models(path_to_save)
```
В функцию нужно передать **существующий** путь до директории, куда необходимо сохранить модель. По переданному пути
будут созданы папки `model` и `first_model` (если `with_refit=True`), а также файлы `best_msku` и `window_width`.
В созданных папках будут храниться соответствующие модели (подробнее см. документацию функции).

## Загрузка сохранённой модели

Для загрузки модели необходимо инициализировать экземпляр класса, куда передать путь до файла с динамикой валюты, если
он передавался при инициализации сохранённой модели. В файле должна быть информация на предсказываемые даты.
```python
some_model = m.MSKUTimeSeriesModel('usd.csv')
```
**Загрузка модели:**
```python
some_model.download_models(path_to_save)
```
Нужно передать путь до директории, куда сохранялась модель. По данному пути не должно было быть никаких изменений 
файлов, иначе функция может вернуть ошибку.

## Файл с динамикой валюты

В этом файле можно передать информацию о любой экономической величине, данные которой изменяются подневно. Мной
использовалась динамика курса доллара (пример файла можно найти в текущей директории - `usd.csv`). Данные можно найти
на любом сайте, содержащую информацию по динамикам экономических единиц.

Файл должен построчно содержать информацию о дате (в формате, поддерживаемом `pandas.to_datetime()`) и может содержать
незначительные пропуски. 

Файл можно передать вместе с инициализацией модели. Тогда предполагается, что в качестве разделителя данных 
в строке используется символ `','`, и данные обрезаются начиная с 2017-01-01.

Если же необходимо передать файл другого формата, до инициализации модели нужно выполнить:
```python
import features as f
f.set_usd_history(path, sep=',', start_date='2017-01-01')
```
И при инициализации пропустить параметр `usd_path`.


